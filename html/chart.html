<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Analytics Chart</title>

  <!-- Google API skripta (učitava se dinamički u JS) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
</head> 
<body>
  <h1>Google Analytics Chart</h1>

  <!-- Gumbi za autentifikaciju -->
  <button id="signin-button" onclick="handleAuthClick()" disabled>Prijavite se s Google računom</button>
  <button id="signout-button" onclick="handleSignoutClick()" disabled>Odjavite se</button>

  <!-- Platno za Chart.js grafikon -->
  <canvas id="chart" style="display: none;"></canvas>

  <script>
    const CLIENT_ID = '1097344377477-00qph6q9jiin2muv6ntpsg9go98lqbfe.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBdJdlS7a_e3oidJYrT9PfnAxPYtXri0UM';
    const DISCOVERY_DOCS = ['https://analyticsdata.googleapis.com/$discovery/rest?version=v1beta'];
    const SCOPES = 'https://www.googleapis.com/auth/analytics.readonly';

    let isAuthenticated = false;

    // Dinamički učitavanje Google API skripte
    function loadGapiScript() {
      const gapiScript = document.createElement('script');
      gapiScript.src = "https://apis.google.com/js/api.js";
      gapiScript.onload = function () {
        gapi.load('client:auth2', initClient);
      };
      document.head.appendChild(gapiScript);
    }

    // Inicijalizacija Google API-ja
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(() => {
        const authInstance = gapi.auth2.getAuthInstance();
        authInstance.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(authInstance.isSignedIn.get());
      }).catch(error => {
        console.error("Greška u inicijalizaciji Google API-ja:", error);
      });
    }

    // Ažuriranje statusa autentifikacije
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        isAuthenticated = true;
        document.getElementById('chart').style.display = 'block';
        document.getElementById('signin-button').disabled = true;
        document.getElementById('signout-button').disabled = false;
        fetchAnalyticsData();
      } else {
        isAuthenticated = false;
        document.getElementById('chart').style.display = 'none';
        document.getElementById('signin-button').disabled = false;
        document.getElementById('signout-button').disabled = true;
      }
    }

    // Prijava korisnika
    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then(user => {
        const token = user.getAuthResponse().access_token;
        localStorage.setItem("access_token", token);
        fetchAnalyticsData();
      }).catch(error => {
        console.error("Prijava nije uspjela:", error);
      });
    }

    // Odjava korisnika
    function handleSignoutClick() {
      gapi.auth2.getAuthInstance().signOut().then(() => {
        localStorage.removeItem("access_token");
        updateSigninStatus(false);
      });
    }

    // Dohvaćanje podataka iz Google Analytics API-ja
    async function fetchAnalyticsData() {
      const token = localStorage.getItem("access_token");
      if (!token) {
        console.error("Nema pristupnog tokena. Prijavite se ponovno.");
        return;
      }

      const propertyId = '474019939';  // Zamijeni s ispravnim Property ID
      const url = `https://analyticsdata.googleapis.com/v1beta/properties/${propertyId}:runReport`;

      const requestBody = {
        dimensions: [{ name: 'date' }, { name: 'country' }],
        metrics: [{ name: 'activeUsers' }],
        dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }]
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) {
          const errorDetails = await response.json();
          console.error(`Greška u API pozivu: ${response.status} - ${errorDetails.error.message}`);
          return;
        }

        const data = await response.json();
        renderChart(data);
      } catch (err) {
        console.error("Greška u dohvaćanju podataka:", err);
      }
    }

    // Prikazivanje grafikona s podacima
    function renderChart(data) {
      if (!data || !data.rows) {
        console.error("Nema podataka za prikaz.");
        return;
      }

      const labels = data.rows.map(row => row.dimensionValues[0].value);
      const values = data.rows.map(row => parseInt(row.metricValues[0].value, 10));

      const chartData = {
        labels: labels,
        datasets: [{
          label: 'Active Users',
          data: values,
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1,
        }],
      };

      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Google Analytics Data' },
          },
        },
      });
    }

    // Pokreni učitavanje Google API-ja kada se stranica učita
    window.onload = loadGapiScript;
  </script>
</body>
</html>
